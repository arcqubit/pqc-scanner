name: Release Please

on:
  push:
    branches:
      - main

# Top-level permissions must be explicitly granted for GITHUB_TOKEN
# This ensures the workflow can create and manage pull requests
permissions:
  contents: write        # Required: Create releases and tags
  pull-requests: write   # Required: Create and manage release PRs
  id-token: write        # Required: GitHub API authentication

jobs:
  release-please:
    name: Create Release PR
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # Job-level permissions (inherits from top-level but can be more restrictive)
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # v5.0.1

      - name: Calculate date-based CalVer
        id: calver
        run: |
          # CalVer format: YYYY.MM.DD.BUILD-beta.RUN_NUMBER
          YEAR=$(date -u +%Y)
          MONTH=$(date -u +%-m)
          DAY=$(date -u +%-d)

          # Get current version from manifest
          CURRENT=$(jq -r '."."' .release-please-manifest.json)
          echo "Current: $CURRENT"

          # Parse current version
          if [[ "$CURRENT" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)\.([0-9]+) ]]; then
            C_YEAR="${BASH_REMATCH[1]}"
            C_MONTH="${BASH_REMATCH[2]}"
            C_DAY="${BASH_REMATCH[3]}"
            C_BUILD="${BASH_REMATCH[4]}"

            # Same date? Increment build. New date? Reset to 0.
            if [ "$C_YEAR" == "$YEAR" ] && [ "$C_MONTH" == "$MONTH" ] && [ "$C_DAY" == "$DAY" ]; then
              BUILD=$((C_BUILD + 1))
            else
              BUILD=0
            fi
          else
            BUILD=0
          fi

          NEW_VERSION="${YEAR}.${MONTH}.${DAY}.${BUILD}-beta.${{ github.run_number }}"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Calculated: $NEW_VERSION"

          # Update manifest
          jq --arg v "$NEW_VERSION" '."." = $v' .release-please-manifest.json > .tmp.json
          mv .tmp.json .release-please-manifest.json

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@5d869da34e18e7287c1daad50e0b8ea0f506ce69  # v1.11.0
        with:
          app-id: ${{ secrets.RELEASE_PLEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_PLEASE_APP_PRIVATE_KEY }}
        continue-on-error: true

      - name: Run Release Please
        id: release
        uses: googleapis/release-please-action@7987652d64b4581673a76e33ad5e98e3dd56832f  # v4.1.3
        with:
          token: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}

      - name: Display Release Please outputs
        if: steps.release.outputs.release_created
        run: |
          echo "Release created: ${{ steps.release.outputs.release_created }}"
          echo "Tag name: ${{ steps.release.outputs.tag_name }}"
          echo "Version: ${{ steps.release.outputs.version }}"
          echo "PR number: ${{ steps.release.outputs.pr }}"
